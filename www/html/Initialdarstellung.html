<!DOCTYPE html>  
 <html>  
      <head>
           <meta charset="UTF-8">
           <title>KO-Phase</title>  
           <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.0/jquery.min.js"></script>  
            <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
      </head>       
      <body>
<!--Navigation-->
          <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
  <a class="navbar-brand" href="#">KO Runde</a>
  <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation">
    <span class="navbar-toggler-icon"></span>
  </button>
  <div class="collapse navbar-collapse" id="navbarNavAltMarkup">
    <div class="navbar-nav">
      <a class="nav-item nav-link" href="../html/index.html">Teams Einfügen</a>
      <a class="nav-item nav-link active" href="#">Ergebnisse Eintragen</a>
      <a class="nav-item nav-link" href="../final_page/index.html">Gewinner</a>
    </div>
  </div>
</nav>
    <br/>  
<!-- leere Tabelle -->
           <div class="container" style="width:500px;">  
                <h3 align="">KO-Phase</h3><br />                 
                <form method="post"><br/>
                    <label>Begegnungen</label><br><br>
                    <div id="tabelle">
                    <table class="table table-bordered table-striped" id="teams_table">
                    </table>
                    </div>
                    <br>
                     <input id="teamsubmit" type="submit" name="nächste Runde" value="nächste Runde" class="btn btn-info" /><br />                      
                </form>  
           </div>  
           <br />
<!--JQuery so ajax works-->
<script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
<!--Popper-->
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js" integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous"></script>
<!--Bootstrap-->
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>
<!--JQuery so mobile menu works-->
<script src="https://code.jquery.com/jquery-3.3.1.min.js" crossorigin="anonymous"></script>
      </body>  
 </html>
<script>
//Teamcount
var teamsremaining=0;
var removereq=0;
var teamCount=0;
//Weiterleitung nach Finalspiel
function init(){
	if(0<removereq)
		{
			window.setTimeout(init,100);
			return;
		}
    $("#teams_table").html("<tr><th>Team 1</th><th>Ergebnis</th><th>Team 2</th></tr>");
	$.ajax({url: "../db/teams.php"}).done(recievedteamnames).fail(failedteamnames);
    
    if(teamsremaining==2)
        {
            window.location.href = "../final_page/index.html"
        }
}
//Teampaarungen
function recievedteamnames(data){
	teams=JSON.parse(data);
        teams.forEach(addTeamName);
}

//Team Tabelle Aufbauen
function addTeamName(team,teamCount)
{
	// Wenn das Team gerade ist
	if(0==teamCount%2)
		// wird das html für die Tabelle in der Linken Spalte generiert
		{
			jQuery('<tr></tr>', 
			{
    			id: "tabrow"+teamCount
    		})
			.appendTo("#teams_table");
			jQuery('<td></td>', 
			{
    			id: "tabteam"+teamCount
    		})
			.appendTo("#tabrow"+teamCount);
			$("#tabteam"+teamCount)
				.html(team.name);
			jQuery('<input/>', 
			{
    			id: "teamleft",
				team_id: "'"+team.id+"'",
				type: "number",
				min: "0",
				name:"score",
				style:"width:50px;float:left;",
				class:"form-control team"
    		})
			.appendTo("#tabrow"+teamCount);
		}
	// Wenn das Team ungerade ist
	else{
			// wird das html für die Tabell in der Rechten Spalte generiert
			jQuery('<input/>', 
			{
    			id: "teamright",
				team_id: "'"+team.id+"'",
				type: "number",
				min: "0",
				name:"score",
				style:"width:50px;float:right;",
				class:"form-control team"
    		})
			.appendTo("#tabrow"+(teamCount-1));
			jQuery('<td></td>', 
			{
    			id: "tabteam"+teamCount
    		})
			.appendTo("#tabrow"+(teamCount-1));
			$("#tabteam"+teamCount)
				.html(team.name);
		}
}
//Fehler bei Teams laden
function failedteamnames(){
	alert("fail");
}

window.onload=init;
	// Verlierer Teams entfernen
	$('#teamsubmit').on('click', function (e) {
		e.preventDefault();
		// finde alle zeilen in der teams tabelle und loope über diese
		$("#teams_table").find("tr").each(function (e) {
			// wenn das linke team höhere punkte als das rechte team hat
			if ($(this).find("#teamleft").val() > $(this).find("#teamright").val()) {
				removereq++;
				teamsremaining++;
				// wird das rechte team via ajax request entfernt
				$.ajax({
					url: "../db/teamremove.php?id=" + $(this).find("#teamright").attr("team_id")
				}).done(removereturned).fail(removereturned);
				// wenn das rechte team höhere punkte als das linke hat
			} else if ($(this).find("#teamleft").val() < $(this).find("#teamright").val()) {
				removereq++;
				teamsremaining++;
				// wird das linke entfernet
				$.ajax({
					url: "../db/teamremove.php?id=" + $(this).find("#teamleft").attr("team_id")
				}).done(removereturned).fail(removereturned);
			} else {
				teamsremaining++;
			}
		});
		init();
		if (teamsremaining > 2) {
			teamsremaining = 0;
		}
	});

	function removereturned() {
		removereq--;
	}
</script>
